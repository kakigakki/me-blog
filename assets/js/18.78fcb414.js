(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{472:function(t,s,a){"use strict";a.r(s);var e=a(8),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"初始化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#初始化"}},[t._v("#")]),t._v(" 初始化")]),t._v(" "),a("p",[t._v("当Nodejs启动时会初始化event loop ，每一个event loop都会包含如下顺序6个循环阶段。\n"),a("img",{attrs:{src:"https://raw.githubusercontent.com/kakigakki/picBed/master/imgs/20211124223833.png",alt:"20211124223833"}})]),t._v(" "),a("blockquote",[a("p",[t._v("图中每个方框被称为事件循环的一个阶段(phase),六个阶段合为一个循环。")])]),t._v(" "),a("h3",{attrs:{id:"_6个阶段概览"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6个阶段概览"}},[t._v("#")]),t._v(" 6个阶段概览")]),t._v(" "),a("h4",{attrs:{id:"timers（定时器）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#timers（定时器）"}},[t._v("#")]),t._v(" timers（定时器）")]),t._v(" "),a("p",[t._v("此阶段执行那些有"),a("code",[t._v("setTimeout()")]),t._v("和"),a("code",[t._v("setInterval()")]),t._v("调度的回调函数")]),t._v(" "),a("h4",{attrs:{id:"i-o-callbakcs-（挂起的回调）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#i-o-callbakcs-（挂起的回调）"}},[t._v("#")]),t._v(" I/O callbakcs （挂起的回调）")]),t._v(" "),a("p",[t._v("此阶段执行延迟到下一个循环迭代的 I/O回调函数，除了"),a("code",[t._v("close callbacks")]),t._v("和那些由"),a("code",[t._v("timer")]),t._v("与"),a("code",[t._v("setImmediate()")]),t._v("调度的回调")]),t._v(" "),a("h4",{attrs:{id:"idle-空转-prepare"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#idle-空转-prepare"}},[t._v("#")]),t._v(" idle(空转),prepare")]),t._v(" "),a("p",[t._v("此阶段只在内部使用。跟我们写的代码没关系")]),t._v(" "),a("h4",{attrs:{id:"poll-轮询"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#poll-轮询"}},[t._v("#")]),t._v(" poll(轮询)")]),t._v(" "),a("p",[t._v("检索新的I/O事件，执行与 I/O 相关的回调（几乎所有情况下，除了关闭的回调函数，那些由"),a("code",[t._v("timer")]),t._v("和 setImmediate() 调度的之外），其余情况 node 将在适当的时候在此阻塞(假如poll队列为空，此时io有一个du)。")]),t._v(" "),a("h4",{attrs:{id:"check"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check"}},[t._v("#")]),t._v(" check")]),t._v(" "),a("p",[a("code",[t._v("setImmediate()")]),t._v(" 回调函数在这里执行。")]),t._v(" "),a("h4",{attrs:{id:"close-callbacks"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#close-callbacks"}},[t._v("#")]),t._v(" close callbacks")]),t._v(" "),a("p",[t._v("一些关闭的回调函数，如："),a("code",[t._v("socket.on('close', ...)")]),t._v("。用得比较少。")]),t._v(" "),a("h3",{attrs:{id:"_6个阶段详细介绍"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_6个阶段详细介绍"}},[t._v("#")]),t._v(" 6个阶段详细介绍")]),t._v(" "),a("h4",{attrs:{id:"timers（定时器）-2"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#timers（定时器）-2"}},[t._v("#")]),t._v(" timers（定时器）")]),t._v(" "),a("blockquote",[a("p",[a("strong",[t._v("注意：轮询 阶段 控制何时定时器执行。poll队列中不再有回调，因此事件循环机制将查看最快到达阈值的timer，然后将回到 timer 阶段，")])])]),t._v(" "),a("p",[t._v("例如，调度了一个在 100 毫秒后超时的定时器，脚本开始异步读取会耗费 95 毫秒的文件:")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("function")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncOperation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token parameter"}},[t._v("callback")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Assume this takes 95ms to complete")]),t._v("\n  fs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/path/to/file'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" callback"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" timeoutScheduled "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" delay "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" timeoutScheduled"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token template-string"}},[a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")]),a("span",{pre:!0,attrs:{class:"token interpolation"}},[a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("${")]),t._v("delay"),a("span",{pre:!0,attrs:{class:"token interpolation-punctuation punctuation"}},[t._v("}")])]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("ms have passed since I was scheduled")]),a("span",{pre:!0,attrs:{class:"token template-punctuation string"}},[t._v("`")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("100")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do someAsyncOperation which takes 95 ms to complete")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("someAsyncOperation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" startCallback "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do something that will take 10ms...")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("Date"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("now")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" startCallback "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// do nothing")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("p",[t._v("此代码的执行流程为下：\n-"),a("code",[t._v("poll")]),t._v("95毫秒\n-"),a("code",[t._v("poll")]),t._v("10毫秒")]),t._v(" "),a("ul",[a("li",[t._v("定时器 0毫秒")])]),t._v(" "),a("p",[t._v("解释：\n当事件循环进入"),a("code",[t._v("poll")]),t._v("阶段时，它有一个空队列（此时 fs.readFile() 尚未完成），因此它将等待剩下的毫秒数，直到达到最快的一个"),a("code",[t._v("timer")]),t._v("阈值为止。当它等待 95 毫秒过后时，fs.readFile() 完成读取文件，如何此时读取文件后没有其他回调的话，那么轮询继续等待5毫秒则会回到"),a("code",[t._v("timer")]),t._v("去执行"),a("code",[t._v("setTimeout()")]),t._v("，这时候脚本总耗时就是最快的一个"),a("code",[t._v("timer")]),t._v("阙值。但是因为有一个需要 10 毫秒才能完成的回调，此回调在95毫秒读取文件完成后，将被添加到"),a("code",[t._v("poll")]),t._v("队列中并执行。当回调完成时，队列中不再有回调，因此事件循环机制将查看最快到达阈值的"),a("code",[t._v("timer")]),t._v("，然后将回到 "),a("code",[t._v("timer")]),t._v(" 阶段，以执行定时器的回调。在本示例中，您将看到调度"),a("code",[t._v("timer")]),t._v("到它的回调被执行之间的总延迟将为 105 毫秒。")]),t._v(" "),a("h4",{attrs:{id:"i-o-callbacks-（挂起的回调函数）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#i-o-callbacks-（挂起的回调函数）"}},[t._v("#")]),t._v(" I/O callbacks （挂起的回调函数）")]),t._v(" "),a("p",[t._v("此阶段对某些系统操作（如 TCP 错误类型）执行回调。例如，如果 TCP 套接字在尝试连接时接收到 ECONNREFUSED，则某些 *nix 的系统希望等待报告错误。这将被排队以在 挂起的回调 阶段执行。")]),t._v(" "),a("h4",{attrs:{id:"poll-（轮询）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#poll-（轮询）"}},[t._v("#")]),t._v(" poll （轮询）")]),t._v(" "),a("p",[t._v("轮询 阶段有两个重要的功能：")]),t._v(" "),a("ol",[a("li",[t._v("计算应该阻塞和"),a("code",[t._v("poll")]),t._v("I/O 的时间。")]),t._v(" "),a("li",[t._v("然后，处理"),a("code",[t._v("poll")]),t._v("队列里的事件，回调。")])]),t._v(" "),a("p",[t._v("当事件循环进入"),a("code",[t._v("poll")]),t._v("阶段且 没有被调度的"),a("code",[t._v("timer")]),t._v("时 ，将发生以下两种情况之一：")]),t._v(" "),a("ul",[a("li",[t._v("如果"),a("code",[t._v("poll")]),t._v("队列不是空的。事件循环将循环访问回调队列并同步执行它们，直到队列已用尽，或者达到了与系统相关的硬性限制。")]),t._v(" "),a("li",[t._v("如果"),a("code",[t._v("poll")]),t._v("队列 是空的 ，还有两件事发生：\n"),a("ul",[a("li",[t._v("如果脚本被"),a("code",[t._v("setImmediate()")]),t._v("调度，则事件循环将结束"),a("code",[t._v("poll")]),t._v("阶段，并继续"),a("code",[t._v("check")]),t._v("阶段以执行那些被调度的脚本。")]),t._v(" "),a("li",[a("code",[t._v("poll")]),t._v("队列为空(没有进去"),a("code",[t._v("check")]),t._v("阶段，且全部的I/O事件，回调执行完毕)，事件循环将检查 "),a("em",[t._v("已达到时间阈值的"),a("code",[t._v("timer")])]),t._v("。如果一个或多个"),a("code",[t._v("timer")]),t._v("已准备就绪，则事件循环将绕回"),a("code",[t._v("timer")]),t._v("阶段以执行这些"),a("code",[t._v("timer")]),t._v("的回调。")]),t._v(" "),a("li",[t._v("如果脚本未被"),a("code",[t._v("setImmediate()")]),t._v("调度，则事件循环将等待回调被添加到队列中，然后立即执行。")])])])]),t._v(" "),a("h4",{attrs:{id:"check（检查阶段）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#check（检查阶段）"}},[t._v("#")]),t._v(" check（检查阶段）")]),t._v(" "),a("p",[a("code",[t._v("setImmediate()")]),t._v(" 回调函数在这里执行。\n一般来说如果"),a("code",[t._v("poll")]),t._v("队列在执行完毕后，会进入阻塞等待下一个事件I/O进来。但是如果"),a("code",[t._v("poll")]),t._v("队列为空时，此时"),a("code",[t._v("check")]),t._v("不为空，则会进入"),a("code",[t._v("check")]),t._v("阶段执行"),a("code",[t._v("setImmediate()")])]),t._v(" "),a("h4",{attrs:{id:"close-callbacks（关闭的回调函数）"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#close-callbacks（关闭的回调函数）"}},[t._v("#")]),t._v(" close callbacks（关闭的回调函数）")]),t._v(" "),a("p",[t._v("如果套接字或处理函数突然关闭（例如 "),a("code",[t._v("socket.destroy()")]),t._v("），则"),a("code",[t._v("'close'")]),t._v("事件将在这个阶段发出。否则它将通过 "),a("code",[t._v("process.nextTick()")]),t._v(" 发出。")]),t._v(" "),a("h3",{attrs:{id:"对比"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#对比"}},[t._v("#")]),t._v(" 对比")]),t._v(" "),a("h4",{attrs:{id:"setimmediate-对比-settimeout"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#setimmediate-对比-settimeout"}},[t._v("#")]),t._v(" "),a("code",[t._v("setImmediate()")]),t._v(" 对比 "),a("code",[t._v("setTimeout()")])]),t._v(" "),a("p",[a("code",[t._v("setImmediate()")]),t._v(" 和 "),a("code",[t._v("setTimeout()")]),t._v(" 很类似，但是基于被调用的时机，他们也有不同表现。")]),t._v(" "),a("ul",[a("li",[a("code",[t._v("setImmediate()")]),t._v(" 设计为一旦在当前"),a("code",[t._v("poll")]),t._v("阶段完成， 就执行脚本。")]),t._v(" "),a("li",[a("code",[t._v("setTimeout()")]),t._v(" "),a("code",[t._v("poll")]),t._v("队列为空时，且存在_已达到时间阈值的"),a("code",[t._v("timer")]),t._v("_过后运行脚本。")])]),t._v(" "),a("p",[t._v("执行计时器的顺序将根据调用它们的上下文而异。如果二者都从主模块内调用，则计时器将受进程性能的约束（这可能会受到计算机上其他正在运行应用程序的影响）。")]),t._v(" "),a("p",[t._v("例如，如果运行以下不在 I/O 周期（即主模块）内的脚本，则执行两个计时器的顺序是非确定性的，因为它受进程性能的约束：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// timeout_vs_immediate.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'timeout'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'immediate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ node timeout_vs_immediate.js\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v("\nimmediate\n\n$ node timeout_vs_immediate.js\nimmediate\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v("\n")])])]),a("p",[t._v("但是，如果你把这两个函数放入一个 I/O 循环内调用，setImmediate 总是被优先调用：")]),t._v(" "),a("div",{staticClass:"language-js extra-class"},[a("pre",{pre:!0,attrs:{class:"language-js"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// timeout_vs_immediate.js")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("const")]),t._v(" fs "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("require")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'fs'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\nfs"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("readFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("__filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setTimeout")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'timeout'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("setImmediate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=>")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    console"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("log")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'immediate'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("$ node timeout_vs_immediate.js\nimmediate\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v("\n\n$ node timeout_vs_immediate.js\nimmediate\n"),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("timeout")]),t._v("\n")])])]),a("p",[t._v("使用"),a("code",[t._v("setImmediate()")]),t._v("相对于"),a("code",[t._v("setTimeout()")]),t._v("的主要优势是，如果"),a("code",[t._v("setImmediate()")]),t._v("是在 I/O 周期内"),a("code",[t._v("check")]),t._v("阶段被调度的，那它将会在其中任何的定时器之前执行，跟这里存在多少个定时器无关")]),t._v(" "),a("h4",{attrs:{id:"process-nexttick-对比-setimmediate"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#process-nexttick-对比-setimmediate"}},[t._v("#")]),t._v(" "),a("code",[t._v("process.nextTick()")]),t._v(" 对比 "),a("code",[t._v("setImmediate()")])]),t._v(" "),a("p",[a("code",[t._v("process.nextTick()")]),t._v("并不属于事件循环的某个阶段，而是在每个阶段执行前执行。\n"),a("img",{attrs:{src:"https://raw.githubusercontent.com/kakigakki/picBed/master/imgs/20211124233635.png",alt:"20211124233635"}})]),t._v(" "),a("p",[t._v("上图代码执行顺序")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("nextTick1\nnextTick2\nsetImmediate\nnextTick3\nsetTimeout\n")])])]),a("p",[t._v("实质上， "),a("code",[t._v("process.nextTick()")]),t._v(" "),a("code",[t._v("setImmediate()")]),t._v("这两个名称应该交换，因为"),a("code",[t._v("process.nextTick()")]),t._v(" 比 "),a("code",[t._v("setImmediate()")]),t._v(" 触发得更快，但这是过去遗留问题，因此不太可能改变。如果贸然进行名称交换，将破坏 npm 上的大部分软件包。每天都有更多新的模块在增加，这意味着我们要多等待每一天，则更多潜在破坏会发生。尽管这些名称使人感到困惑，但它们本身名字不会改变。\n"),a("em",[t._v("建议开发人员在所有情况下都使用 setImmediate()，因为它更容易理解。")])])])}),[],!1,null,null,null);s.default=n.exports}}]);