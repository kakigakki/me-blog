---
title: MySQL进阶笔记
author: kaki
date: 2021-02-05
location: Tokyo
tags:
  - DB
toc: true
---

### 如何设计索引系统

前置知识：MySQL 每次读取磁盘都是读取 16k.

索引存储在磁盘中，查询数据的时候会优先将索引加载到内存中

#### MySQL 的索引系统

##### 为什么不用哈希表作为索引的数据结构？

- 缺点

  - 哈希冲突会造成数据散列不均匀，会产生大量的线性查询，浪费时间
  - 不支持范围，但进行范围查询的时候，需要遍历
  - 对于内存空间的要求比较高

- 优点
  - 等值查询会很快

##### 为什么要使用 B+树作为存储数据的数据结构？

- 因为其他的树如二叉树，平衡二叉树都是只有两个分叉，存的数据太多时，树的深度会非常大

- b 树的各个节点也存储数据，且数据占用空间大，所以能存储的数据比较小

- b+树只在叶子节点存储数据，其他父节点只存储指针和索引，所以索引越小，能存储的索引越多，读表速度就会提升

##### 聚簇索引，非聚簇索引

- 是否是聚簇索引取决于 B+树中的叶子节点里数据跟索引是否是放在一起的，如果是非聚簇索引，B+树中的叶子节点里，非聚簇索引放的是聚簇索引，先通过非聚簇索引找到聚簇索引，再通过聚簇索引找数据
- innodb 存储只能有一个聚簇索引，向 innodb 插入数据的时候，必须要包含一个索引的 key 值,这个 key 值，可以是主键，如果没有主键，那么就是唯一键，如果没有唯一键，那么就是一个自生成的 6 字节的 rowid
- innodb 可以有很多非聚簇索

##### 回表

当根据普通索引查询到聚簇索引的 key 值之后，再根据 key 值在聚簇索引中获取所有行的数据

```js
//假设有一张表，有id,name,age,gender四个字段，id是主键，name是索引列。此时id为聚簇索引，name为非聚簇索引

select * from table where name = 'zhangsan'
//上面sql文，先根据name索引查询id，再根据id查询整行的记录。走了2棵b+树。这种现场叫做回表
```

##### 索引覆盖

根据索引可以直接查询到所有索引列的值，直接返回即可。不需要从聚簇索引查询任何数据，此时叫做索引覆盖。比回表效率高。只走了一棵 b+树

```js
select id,name from table where name = 'zhangsan'
//上面sql文，就是索引覆盖。不需要再通过聚簇索引查询整行记录
```

##### 最左匹配

使用组合索引的时候必须先匹配组合中的左边索引列，再匹配右边索引列

```js
//假如有name,age的组合索引，下列是sql中组合索引生效情况
select id,name from table where name = ? //用
select id,name from table where name = ? and age = ? //用
select id,name from table where age= ? //不用
select id,name from table where age = ? and name = ? // 用，因为mysql内部有优化器，会调整对应的顺序
```

##### 索引下推

根据组合索引的多个索引列，直接在存储引擎中获取对应的数据

补充： 数据库一般有三层： client（可视化工具） > server（MySQL 服务） > 存储引擎(innodb)
